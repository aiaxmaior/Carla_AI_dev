"""
Q-DRIVE Cortex Vision Package
============================

This package contains computer vision and perception systems for Q-DRIVE Cortex.

The Vision package implements advanced perception algorithms that enable the simulator
to understand the driving environment and provide intelligent feedback. It serves as
the "perfect AI" that knows ground truth about the simulation world.

Key Components:

Perception Systems:
- VisionPerception: Main computer vision system using CARLA ground truth
- Object detection and tracking for vehicles, pedestrians, and obstacles
- Real-time distance and trajectory analysis

Driver Monitoring:
- DMS (Driver Monitoring System): Eye tracking and alertness detection
- AlertLevel: Driver alertness classification
- EyeMetrics: Eye movement and gaze tracking metrics
- DriverState: Comprehensive driver state assessment

Environmental Analysis:
- ObjectTracker: Multi-object tracking with trajectory prediction
- LaneDetection: Lane boundary and road geometry analysis
- HazardAnalysis: Real-time hazard identification and risk assessment

Data Processing:
- Multi-threaded image processing pipeline
- Efficient bounding box and overlay rendering
- Performance-optimized computer vision algorithms

Integration:
- Seamless integration with HUD overlay systems  
- Real-time data feeding to scoring and analytics systems
- Ground truth validation for AI training datasets
"""

__version__ = "1.5.0"
__author__ = "Q-DRIVE Cortex Team"

import logging

# Set up module logger
logger = logging.getLogger(__name__)

# Core Vision Perception Module
try:
    from .VisionPerception import VisionPerception
    _vision_perception_available = True
    logger.debug("VisionPerception module loaded successfully")
except ImportError as e:
    _vision_perception_available = False
    VisionPerception = None
    logger.warning(f"VisionPerception module not available: {e}")

# Driver Monitoring System (DMS) Module
try:
    from .DMS_Module import AlertLevel, EyeMetrics, DriverState, DMS
    _dms_available = True
    logger.debug("DMS module loaded successfully")
except ImportError as e:
    _dms_available = False
    AlertLevel = None
    EyeMetrics = None
    DriverState = None
    DMS = None
    logger.warning(f"DMS module not available: {e}")

# Object Tracking Module
try:
    from .ObjectTracker import ObjectTracker, TrackedObject
    _object_tracking_available = True
    logger.debug("ObjectTracker module loaded successfully")
except ImportError as e:
    _object_tracking_available = False
    ObjectTracker = None
    TrackedObject = None
    logger.info(f"ObjectTracker module not available: {e}")

# Lane Detection Module
try:
    from .LaneDetection import LaneDetector, LaneGeometry
    _lane_detection_available = True
    logger.debug("LaneDetection module loaded successfully")
except ImportError as e:
    _lane_detection_available = False
    LaneDetector = None
    LaneGeometry = None
    logger.info(f"LaneDetection module not available: {e}")

# Hazard Analysis Module
try:
    from .HazardAnalysis import HazardDetector, RiskAssessment
    _hazard_analysis_available = True
    logger.debug("HazardAnalysis module loaded successfully")
except ImportError as e:
    _hazard_analysis_available = False
    HazardDetector = None
    RiskAssessment = None
    logger.info(f"HazardAnalysis module not available: {e}")

# Module availability summary
AVAILABLE_MODULES = {
    'VisionPerception': _vision_perception_available,
    'DMS': _dms_available,
    'ObjectTracker': _object_tracking_available,
    'LaneDetection': _lane_detection_available,
    'HazardAnalysis': _hazard_analysis_available
}

# Public API exports
__all__ = [
    # Version info
    '__version__',
    '__author__',
    
    # Core perception
    'VisionPerception',
    
    # Driver monitoring
    'AlertLevel',
    'EyeMetrics', 
    'DriverState',
    'DMS',
    
    # Object tracking
    'ObjectTracker',
    'TrackedObject',
    
    # Lane detection
    'LaneDetector',
    'LaneGeometry',
    
    # Hazard analysis
    'HazardDetector',
    'RiskAssessment',
    
    # Utility functions
    'check_module_availability',
    'get_available_modules',
    'is_module_available',
]

# Utility functions for module availability checking
def check_module_availability(verbose=False):
    """
    Check and report availability of all vision modules.
    
    Args:
        verbose (bool): If True, print detailed availability information.
    
    Returns:
        dict: Dictionary mapping module names to availability status.
    """
    if verbose:
        print("\n" + "="*50)
        print("Q-DRIVE Vision Package Module Availability")
        print("="*50)
        for module, available in AVAILABLE_MODULES.items():
            status = "✓ Available" if available else "✗ Not Available"
            print(f"{module:20s}: {status}")
        print("="*50 + "\n")
    
    return AVAILABLE_MODULES.copy()

def get_available_modules():
    """
    Get list of available vision modules.
    
    Returns:
        list: Names of available modules.
    """
    return [name for name, available in AVAILABLE_MODULES.items() if available]

def is_module_available(module_name):
    """
    Check if a specific module is available.
    
    Args:
        module_name (str): Name of the module to check.
    
    Returns:
        bool: True if module is available, False otherwise.
    """
    return AVAILABLE_MODULES.get(module_name, False)

# Initialize warning for missing critical modules
def _check_critical_modules():
    """Internal function to warn about missing critical modules."""
    critical_modules = ['VisionPerception']
    missing_critical = [m for m in critical_modules if not AVAILABLE_MODULES.get(m, False)]
    
    if missing_critical:
        logger.warning(
            f"Critical vision modules missing: {', '.join(missing_critical)}. "
            f"Some Q-DRIVE Vision features may not function correctly."
        )

# Run critical module check on import
_check_critical_modules()

# Optional: Auto-configuration based on available modules
def auto_configure():
    """
    Automatically configure vision system based on available modules.
    
    Returns:
        dict: Configuration dictionary with available features.
    """
    config = {
        'perception_enabled': _vision_perception_available,
        'dms_enabled': _dms_available,
        'tracking_enabled': _object_tracking_available,
        'lane_detection_enabled': _lane_detection_available,
        'hazard_detection_enabled': _hazard_analysis_available,
    }
    
    # Set fallback modes for missing modules
    if not _vision_perception_available:
        config['use_basic_perception'] = True
        logger.info("VisionPerception not available, using basic perception mode")
    
    if not _dms_available:
        config['use_basic_alertness'] = True
        logger.info("DMS not available, using basic alertness monitoring")
    
    return config

# Module initialization success message
if any(AVAILABLE_MODULES.values()):
    logger.info(f"Q-DRIVE Vision Package v{__version__} initialized with {len(get_available_modules())} modules")
else:
    logger.error("No vision modules could be loaded. Please check your installation.")