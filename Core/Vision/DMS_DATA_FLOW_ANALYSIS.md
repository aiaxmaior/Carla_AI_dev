# DMS Module - Data Flow & Decision Logic Analysis

**Module:** `Core/Vision/DMS_Module.py`
**Date:** 2025-10-14
**Author Analysis:** Q-DRIVE Cortex System

---

## Table of Contents
1. [Data Structures Overview](#data-structures-overview)
2. [Output Metrics & Scores](#output-metrics--scores)
3. [Event Flags](#event-flags)
4. [Decision Thresholds](#decision-thresholds)
5. [Data Flow Pipeline](#data-flow-pipeline)
6. [Logging Requirements](#logging-requirements)

---

## Data Structures Overview

### 1. EyeMetrics (Per-Eye Data)
**Location:** `DMS_Module.py:96-102`

| Field | Type | Range/Unit | Description |
|-------|------|------------|-------------|
| `center` | Tuple[float, float] | (x, y) pixels | Iris center position in image coordinates |
| `radius` | float | pixels | Iris radius in pixels |
| `aspect_ratio` | float | 0.0 - 1.0+ | Eye height/width ratio (for blink detection) |
| `is_closed` | bool | True/False | Eye closure state |
| `iris_position` | Tuple[float, float] | (-1 to 1, -1 to 1) | Normalized iris position within eye |

**Generated By:** `_process_eye()` at line 417

---

### 2. DriverState (Complete Driver State)
**Location:** `DMS_Module.py:105-129`

#### Eye Metrics
| Field | Type | Description |
|-------|------|-------------|
| `left_eye` | EyeMetrics | Complete left eye data |
| `right_eye` | EyeMetrics | Complete right eye data |

#### Aggregate Metrics
| Field | Type | Range/Unit | Description |
|-------|------|------------|-------------|
| `eyes_closed_duration_ms` | float | milliseconds | Duration eyes have been closed |
| `blink_rate` | float | blinks/minute | Blink frequency |
| `gaze_vector` | Tuple[float, float, float] | (x, y, z) unit vector | 3D gaze direction (forward = 0,0,1) |
| `head_pose` | Tuple[float, float, float] | (yaw, pitch, roll) degrees | Head orientation angles |

#### Computed Scores
| Field | Type | Range | Description | Computed By |
|-------|------|-------|-------------|-------------|
| `drowsiness_score` | float | 0.0 - 1.0 | Drowsiness level | `_calculate_drowsiness()` line 536 |
| `distraction_score` | float | 0.0 - 1.0 | Distraction level | `_calculate_distraction()` line 516 |
| `attention_score` | float | 0.0 - 1.0 | Overall attention | `1.0 - max(drowsiness, distraction)` line 409 |

#### Event Flags
| Field | Type | Description | Set By |
|-------|------|-------------|--------|
| `microsleep_detected` | bool | Eyes closed > 500ms | `_detect_blinks()` line 497 |
| `looking_at_phone` | bool | Gaze in phone zone | `_calculate_distraction()` line 532 |
| `head_down_event` | bool | Head pitch < -15° | `_calculate_drowsiness()` line 555 |

#### Alert Level
| Field | Type | Values | Determined By |
|-------|------|--------|---------------|
| `alert_level` | AlertLevel | NORMAL, CAUTION, WARNING, CRITICAL | `_determine_alert_level()` line 565 |

#### Metadata
| Field | Type | Description |
|-------|------|-------------|
| `timestamp` | float | Unix timestamp (seconds) |

---

## Output Metrics & Scores

### Primary Scores

#### 1. Drowsiness Score
**Range:** 0.0 (alert) → 1.0 (extremely drowsy)
**Location:** `_calculate_drowsiness()` line 536-557

**Components:**
| Condition | Score Contribution | Threshold |
|-----------|-------------------|-----------|
| Eyes closed > 200ms | +0.0 to +0.5 (scaled) | 200ms |
| Microsleep detected | Set to 1.0 (override) | 500ms |
| Abnormal blink rate | +0.2 | <10 or >30 blinks/min |
| Head tilted down | +0.3 | pitch < -15° |
| Repeated microsleeps (trend) | +0.2 | >2 in last 30 frames |

**Formula:**
```python
score = 0.0
if eyes_closed_duration_ms > 200:
    score += min(eyes_closed_duration_ms / 1000, 0.5)
if microsleep_detected:
    score = 1.0  # Override
if blink_rate > 30 or blink_rate < 10:
    score += 0.2
if head_pose[1] < -15:  # pitch
    score += 0.3
return min(score, 1.0)
```

---

#### 2. Distraction Score
**Range:** 0.0 (focused) → 1.0 (completely distracted)
**Location:** `_calculate_distraction()` line 516-534

**Components:**
| Condition | Score Contribution | Threshold |
|-----------|-------------------|-----------|
| Not looking forward | +0.3 | gaze.z < 0.8 |
| Head turned | +0.4 | |yaw| > 30° |
| Looking at phone zone | +0.3 | gaze.y < -0.3 AND |gaze.x| > 0.3 |

**Formula:**
```python
score = 0.0
gaze_forward = state.gaze_vector[2]
if gaze_forward < 0.8:
    score += 0.3
yaw_abs = abs(state.head_pose[0])
if yaw_abs > distraction_angle_deg:  # 30°
    score += 0.4
if is_looking_at_phone_zone(state):
    score += 0.3
return min(score, 1.0)
```

---

#### 3. Attention Score
**Range:** 0.0 (no attention) → 1.0 (full attention)
**Location:** Line 409

**Formula:**
```python
attention_score = 1.0 - max(distraction_score, drowsiness_score)
```

**Interpretation:**
- 1.0 = Fully attentive
- 0.7 - 1.0 = Acceptable (green in UI)
- 0.3 - 0.7 = Reduced attention
- 0.0 - 0.3 = Poor attention (red in UI)

---

### Secondary Metrics

#### Blink Rate
**Unit:** Blinks per minute
**Normal Range:** 10-30 blinks/min
**Calculated:** Rolling window of last 20 blinks
**Location:** Line 513

#### Eye Closure Duration
**Unit:** Milliseconds
**Normal Blink:** 100-400ms
**Microsleep Threshold:** 500ms
**Location:** Line 493

#### Gaze Vector
**Format:** (x, y, z) unit vector
**Forward:** (0, 0, 1)
**Down:** (0, -1, 0)
**Right:** (1, 0, 0)

#### Head Pose
**Format:** (yaw, pitch, roll) in degrees
**Yaw:** Left (-) / Right (+)
**Pitch:** Up (+) / Down (-)
**Roll:** Tilt left (-) / Tilt right (+)

---

## Event Flags

### 1. Microsleep Detection
**Flag:** `microsleep_detected`
**Trigger:** Eyes closed > 500ms
**Location:** Line 496-497
**Impact:** Sets drowsiness_score = 1.0 immediately

```python
if eyes_closed_duration_ms > calibration['microsleep_ms']:  # 500ms
    state.microsleep_detected = True
```

---

### 2. Phone Use Detection
**Flag:** `looking_at_phone`
**Trigger:** Gaze vector in phone zone
**Location:** Line 532
**Phone Zone Definition:** Line 559-563

```python
# Phone typically held lower and to the side
is_phone = (gaze_vector[1] < -0.3 and      # Looking down
            abs(gaze_vector[0]) > 0.3)      # Looking to side
```

---

### 3. Head Down Event
**Flag:** `head_down_event`
**Trigger:** Head pitch < -15°
**Location:** Line 555
**Associated With:** Drowsiness (nodding off)

---

## Decision Thresholds

### Configurable Calibration Parameters
**Location:** Line 189-195

| Parameter | Default Value | Unit | Purpose |
|-----------|---------------|------|---------|
| `eye_closed_threshold` | 0.2 | ratio | Eye aspect ratio below = closed |
| `microsleep_ms` | 500 | milliseconds | Duration to trigger microsleep |
| `distraction_angle_deg` | 30 | degrees | Head yaw threshold |
| `phone_zone` | (0.3, 0.7, 0.7, 0.9) | normalized bbox | Phone detection region |

---

### Alert Level Thresholds
**Location:** `_determine_alert_level()` line 565-576

| Alert Level | Score Range | Color (Debug UI) | Action Recommended |
|-------------|-------------|------------------|-------------------|
| NORMAL | < 0.3 | Green | No action |
| CAUTION | 0.3 - 0.5 | Yellow | Monitor |
| WARNING | 0.5 - 0.7 | Orange | Alert driver |
| CRITICAL | ≥ 0.7 | Red | Immediate intervention |

**Decision Logic:**
```python
max_score = max(distraction_score, drowsiness_score)
if max_score < 0.3:      return NORMAL
elif max_score < 0.5:    return CAUTION
elif max_score < 0.7:    return WARNING
else:                    return CRITICAL
```

---

## Data Flow Pipeline

### Frame Processing Flow
```
Camera Frame (640x480 @ 30fps)
    ↓
[_capture_loop] Producer Thread
    ↓
frame_queue (maxsize=2)
    ↓
[_process_loop] Consumer Thread
    ↓
_process_frame(frame) → DriverState
    │
    ├─→ GPU/CPU Color Conversion (BGR→RGB)
    ├─→ MediaPipe Face Mesh
    ├─→ _process_eye() × 2 (left, right)
    ├─→ _estimate_head_pose()
    ├─→ _estimate_gaze()
    ├─→ _detect_blinks()
    ├─→ _calculate_distraction()
    ├─→ _calculate_drowsiness()
    ├─→ _determine_alert_level()
    ↓
state_queue (maxsize=10)
    ↓
Consumer (Main Application)
```

### Decision Points in Pipeline

#### 1. Eye Processing (`_process_eye`)
**Input:** Facial mesh points
**Output:** EyeMetrics
**Decision:** Is eye closed? (aspect_ratio < 0.2)

#### 2. Blink Detection (`_detect_blinks`)
**Input:** Current DriverState
**Output:** Updated state with blink metrics
**Decisions:**
- Both eyes closed? → Start/continue closure timer
- Eyes reopened? → Record blink if 100-400ms
- Closure > 500ms? → Set microsleep flag

#### 3. Distraction Calculation (`_calculate_distraction`)
**Input:** DriverState (gaze, head_pose)
**Output:** distraction_score
**Decisions:**
- Gaze not forward? → +0.3
- Head turned too far? → +0.4
- Looking at phone? → +0.3 + set flag

#### 4. Drowsiness Calculation (`_calculate_drowsiness`)
**Input:** DriverState (eye closure, blink rate, head pose)
**Output:** drowsiness_score
**Decisions:**
- Long closure? → +0.0 to +0.5
- Microsleep? → Override to 1.0
- Abnormal blink rate? → +0.2
- Head down? → +0.3 + set flag

#### 5. Alert Level Determination (`_determine_alert_level`)
**Input:** distraction_score, drowsiness_score
**Output:** AlertLevel enum
**Decision:** Max of two scores → map to 4-level alert

#### 6. Aggregate Trends (`_update_aggregate_metrics`)
**Input:** Last 30 states (1 second @ 30fps)
**Output:** Adjusted drowsiness_score
**Decision:** >2 microsleeps in 1 second? → +0.2 to drowsiness

---

## Logging Requirements

### Critical Data to Log

#### Per-Frame Logs (30 Hz)
```python
{
    "timestamp": float,
    "fps": float,

    # Eye Data
    "left_eye": {
        "center": (x, y),
        "radius": float,
        "aspect_ratio": float,
        "is_closed": bool,
        "iris_position": (x, y)
    },
    "right_eye": { ... },

    # Aggregate Metrics
    "eyes_closed_duration_ms": float,
    "blink_rate": float,
    "gaze_vector": (x, y, z),
    "head_pose": (yaw, pitch, roll),

    # Scores
    "drowsiness_score": float,
    "distraction_score": float,
    "attention_score": float,

    # Flags
    "microsleep_detected": bool,
    "looking_at_phone": bool,
    "head_down_event": bool,

    # Alert
    "alert_level": str  # "NORMAL", "CAUTION", "WARNING", "CRITICAL"
}
```

#### Event-Based Logs (As Needed)
- Microsleep events (with duration)
- Alert level changes (transitions)
- Phone use detection events
- Head down events
- Blink events (with duration)

#### Aggregate Logs (Every Second)
- Average attention score
- Total microsleep count
- Blink rate
- Alert level distribution
- Max distraction/drowsiness scores

---

## Implementation Recommendations

### 1. Add Structured Logging
```python
import logging
import json

class DMS:
    def __init__(self, ...):
        # Add structured logger
        self.data_logger = logging.getLogger('dms.data')
        handler = logging.FileHandler('dms_telemetry.jsonl')
        handler.setFormatter(logging.Formatter('%(message)s'))
        self.data_logger.addHandler(handler)
        self.data_logger.setLevel(logging.INFO)

    def _log_state(self, state: DriverState):
        """Log complete driver state as JSON"""
        log_data = {
            "timestamp": state.timestamp,
            "fps": self.fps,
            "left_eye": {
                "center": state.left_eye.center,
                "radius": state.left_eye.radius,
                "aspect_ratio": state.left_eye.aspect_ratio,
                "is_closed": state.left_eye.is_closed,
                "iris_position": state.left_eye.iris_position
            },
            "right_eye": {
                "center": state.right_eye.center,
                "radius": state.right_eye.radius,
                "aspect_ratio": state.right_eye.aspect_ratio,
                "is_closed": state.right_eye.is_closed,
                "iris_position": state.right_eye.iris_position
            },
            "eyes_closed_duration_ms": state.eyes_closed_duration_ms,
            "blink_rate": state.blink_rate,
            "gaze_vector": state.gaze_vector,
            "head_pose": state.head_pose,
            "drowsiness_score": state.drowsiness_score,
            "distraction_score": state.distraction_score,
            "attention_score": state.attention_score,
            "microsleep_detected": state.microsleep_detected,
            "looking_at_phone": state.looking_at_phone,
            "head_down_event": state.head_down_event,
            "alert_level": state.alert_level.name
        }
        self.data_logger.info(json.dumps(log_data))
```

### 2. Add Event Logger
```python
def _log_event(self, event_type: str, details: dict):
    """Log significant events"""
    event_data = {
        "timestamp": time.time(),
        "event_type": event_type,
        "details": details
    }
    logging.info(f"DMS_EVENT: {json.dumps(event_data)}")

# Usage examples:
if state.microsleep_detected:
    self._log_event("MICROSLEEP", {
        "duration_ms": state.eyes_closed_duration_ms
    })

if state.alert_level != prev_alert_level:
    self._log_event("ALERT_CHANGE", {
        "from": prev_alert_level.name,
        "to": state.alert_level.name,
        "drowsiness": state.drowsiness_score,
        "distraction": state.distraction_score
    })
```

### 3. Add Performance Metrics
```python
def _log_performance_stats(self):
    """Log performance metrics every second"""
    if len(self._state_history) > 0:
        stats = {
            "avg_fps": self.fps,
            "avg_attention": np.mean([s.attention_score for s in self._state_history]),
            "microsleep_count": sum(1 for s in self._state_history if s.microsleep_detected),
            "alert_distribution": {
                "NORMAL": sum(1 for s in self._state_history if s.alert_level == AlertLevel.NORMAL),
                "CAUTION": sum(1 for s in self._state_history if s.alert_level == AlertLevel.CAUTION),
                "WARNING": sum(1 for s in self._state_history if s.alert_level == AlertLevel.WARNING),
                "CRITICAL": sum(1 for s in self._state_history if s.alert_level == AlertLevel.CRITICAL),
            }
        }
        logging.info(f"DMS_STATS: {json.dumps(stats)}")
```

---

## Summary

### Key Metrics to Monitor
1. **attention_score** - Primary indicator (0-1)
2. **alert_level** - Actionable state (4 levels)
3. **microsleep_detected** - Critical safety flag
4. **drowsiness_score** - Fatigue indicator
5. **distraction_score** - Focus indicator

### Decision Flow Summary
```
Raw Data → Metrics → Scores → Alert Level → Action
   ↓          ↓         ↓          ↓           ↓
Eye/Head   Blinks   Drowsy    CRITICAL    Intervention
Position   Gaze     Distract  WARNING     Alert
           Pose                CAUTION     Monitor
                              NORMAL      None
```

### Critical Thresholds to Tune
- Eye closure: 200ms (long), 500ms (microsleep)
- Blink rate: 10-30 blinks/min (normal range)
- Head yaw: 30° (distraction)
- Head pitch: -15° (drowsiness)
- Gaze forward: 0.8 (z-component)
- Alert levels: 0.3, 0.5, 0.7 (boundaries)

---

**End of Analysis**
